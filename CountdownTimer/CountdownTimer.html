<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="Content/bootstrap.css" rel="stylesheet" />
    <link href="Content/Site.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Raleway" />

    <link href="Content/font-awesome.css" rel="stylesheet" />
    <link href="Content/font-awesome.min.css" rel="stylesheet" />

    <script src="Scripts/jquery-3.5.1.js"></script>
    <script src="Scripts/popper.js"></script>
    <script src="Scripts/bootstrap.js"></script>

    <title>TeamTime</title>
</head>

<body class="">
    <nav class="navbar">
        <span class="navbar-brand"><strong>TeamTime</strong></span>
    </nav>
    <div class="container-fluid" id="main">
        <div class="row">
            <div class="col-1" id="placeholderDivToMoveOtherDivsRightLol">

            </div>
            <!-- timer div -->
            <div class="col-6" id="timer">
                <div class="body-content">

                    <!-- SVG ANIMATION -->
                    <svg width="330" height="330">
                        <g>
                            <!-- inner/outer lines set to fill="none" currently so you wont see them -->
                            <!--outer circle -->
                            <circle cx="164" cy="164" r="148" stroke-width="5" fill="transparent" stroke="cyan" opacity=".8"></circle>
                            <!-- animation stroke-->
                            <circle id="circle" class="circle_animation" r="137.76" cx="164" cy="164" stroke-width="16" stroke="#fc00ff" fill="transparent" opacity=".8"></circle>
                            <!-- inner circle -->
                            <circle cx="164" cy="164" r="128" stroke-width="5" fill="transparent" stroke="cyan" opacity=".8"></circle>
                            <!-- task remaining timer -->
                            <text id="taskCountdown" x="65" y="40" fill="transparent" transform="rotate(90,90,90)" font-size="50" style="fill: #d9d9d9">00:00:00</text>
                            <!-- total timer-->
                            <text x="95" y="70" transform="rotate(90,90,90)" font-size="8" style="fill: #d9d9d9">Total Time</text>
                            <text id="totalTime" x="80" y="87" fill="transparent" transform="rotate(90,90,90)" font-size="15" style="fill: #d9d9d9">00:00:00</text>
                            <!-- total remaining timer -->
                            <text x="195" y="70" transform="rotate(90,90,90)" font-size="8" style="fill:#d9d9d9">Total Remaining</text>
                            <text id="totalCountdown" x="190" y="87" fill="transparent" transform="rotate(90,90,90)" font-size="15" style="fill: #d9d9d9">00:00:00</text>
                        </g>
                    </svg>
                    <!-- Timer Buttons -->
                    <div class="row" style="justify-content: center; margin-top: 25px" id="timerButtons">
                        <button type="button" id="start"><i class="fa fa-play"></i></button>
                        <button type="button" id="pause"><i class="fa fa-pause"></i></button>
                        <button type="button" id="stop"><i class="fa fa-stop"></i></button>
                        <button type="button" id="clear"><i class="fa fa-times fa-lg"></i></button>
                    </div>
                </div>
                <!-- Configure div -->
                <div class="row-cols-lg-2" id="settings" style="justify-content: center; margin-top: 25px">
                    <div class="body-content">
                        <div class="form-group">
                            <div>
                                <small class="form-text"><strong>Enter a task name</strong></small>
                                <input type="text" class="form-control mx-auto align-content-lg-center" id="addTask" />
                            </div>
                            <div>
                                <small class="form-text"><strong>Enter a task duration (minutes)</strong></small>
                                <input type="number" class="form-control mx-auto align-content-lg-center" id="addTaskDuration" />
                            </div>
                            <div style="text-align: center">
                                <button id="task" style="margin-top: 15px">Add Task</button>
                            </div>

                            <div id="csvDiv">
                                <br />
                                <button id="exportToCSV">Export CSV</button>
                                <input type="file" name="importCSV" id="importCSV" accept=".csv" hidden />
                                <label for="importCSV" id="importLabel">Import CSV</label>
                                <!-- Alerts -->
                                <div class="alert alert-light alert-dismissible fade hide" role="alert" id="alert">
                                    <p id="alertText" style="margin-left: 20%; text-align: center; font-size: 14px; font-weight: bold;" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Task List -->
            <div class="col-3" style="margin-top: 50px">
                <div class="card-group">
                    <ol class="list-group list-group-flush" id="timerTaskList" style="width: 100%">
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <script>

        //Global Variables
        var myTimer;

        var globalSeconds = 0;
        var globalSecondsCompleted = 0;
        var globalSecondsRemaining = 0;

        var taskSeconds = 0;
        var taskSecondsCompleted = 0;
        var taskSecondsRemaining = 0;

        var taskTracker = 0;

        var exportInfo = [];
        var backupArray = [];

        var paused = false;
        var started = false;

        const circumference = 2 * Math.PI * document.getElementById("circle").getAttribute('r');

        //Event Handlers
        //Task/Timer
        $("#task").on('click', function () { addTask($("#addTask").val(), $("#addTaskDuration").val()); });
        $("#start").on('click', start);
        $("#pause").on('click', pause);
        $("#stop").on('click', stop);
        $("#clear").on('click', clear);

        //CSV
        var input = document.querySelector('input[type="file"]');
        input.addEventListener('change', importCSV);
        $("#exportToCSV").on('click', exportCSV);

        //TIMER FUNCTIONS

        /* Animates the SVG circle based on the task time. */

        function animate() {
            $('.circle_animation').css('stroke-dashoffset', circumference - ((taskSecondsCompleted) * (circumference / taskSeconds)));
        }

        /* Stops the animation and resets it to the default position. */

        function stopAnimation() {
            $('.circle_animation').css('stroke-dashoffset', circumference);
        }

        /* Starts the clock, or resumes if it was paused. */

        function start() {
            //Prevent start from being executed if there are no tasks or all tasks are already complete.
            if (globalSecondsRemaining === 0)
                return;

            if (paused) {
                document.getElementById("pause").classList.remove('pressed');
            }

            this.disabled = true;
            document.getElementById("start").classList.add('pressed');
            started = true;
            paused = false;
            myTimer = setInterval(timer, 1000);
        }

        /* Contains the core logic for the timer, and tracks the status of sub-tasks. */

        function timer() {
            const currentTask = document.getElementsByTagName('li')[taskTracker];
            const nextTask = document.getElementsByTagName('li')[taskTracker + 1];

            if (typeof (currentTask) != "undefined") {
                currentTask.setAttribute('active', 'true');
            }

            globalSecondsCompleted++;
            globalSecondsRemaining--;
            taskSecondsCompleted++;
            taskSecondsRemaining--;

            animate();

            //Completed task
            if (currentTask.getAttribute('minutes') * 60 === taskSecondsCompleted) {
                currentTask.setAttribute('complete', 'true');
                currentTask.setAttribute('active', 'false');
                currentTask.textContent += ": Complete";
                taskSecondsCompleted = 0;
                taskTracker++;

                //Sets the task timer to the next task (if there is one)
                if (typeof (nextTask) != "undefined") {
                    taskSeconds = nextTask.getAttribute('minutes') * 60;
                    taskSecondsRemaining = taskSeconds;
                }
            }

            setTimerText("#totalCountdown", globalSecondsRemaining);
            setTimerText("#taskCountdown", taskSecondsRemaining);

            //All tasks completed
            if (globalSecondsRemaining <= 0) {
                clearInterval(myTimer);
                document.getElementById("start").disabled = false;
                started = false;
                taskSeconds = 0;
                taskSecondsRemaining = 0;
            }
        }

        /* Pauses the timer */

        function pause() {
            if (paused || !started)
                return;

            clearInterval(myTimer);
            paused = true;
            document.getElementById("start").disabled = false;
            document.getElementById("start").classList.remove('pressed');
            document.getElementById("pause").classList.add('pressed');
        }

        /* Resets the timer to default values without deleting any tasks */

        function stop() {

            clearInterval(myTimer);
            stopAnimation();

            paused = false;
            started = false;
            globalSecondsCompleted = 0;
            globalSecondsRemaining = globalSeconds;
            taskSeconds = 0;
            taskSecondsCompleted = 0;
            taskSecondsRemaining = 0;
            taskTracker = 0;

            document.getElementById("start").classList.remove('pressed');
            document.getElementById("pause").classList.remove('pressed');

            //This block of code doesn't execute when this method is called inside clear().
            //Resets all tasks to display as incomplete and resets the task timer.
            if (this === document.getElementById("stop")) {
                const taskList = document.getElementsByTagName('li');
                $.each(taskList, function (i) {

                    if (i === 0 && typeof (taskList[0]) != "undefined") {
                        taskSeconds = taskList[0].getAttribute('minutes') * 60;
                        taskSecondsRemaining = taskSeconds;
                    }
                    if (taskList[i].getAttribute('complete') === 'true') {
                        taskList[i].setAttribute('complete', 'false');
                    }
                    if (taskList[i].getAttribute('active') === 'true') {
                        taskList[i].setAttribute('active', 'false');
                    }
                    taskList[i].textContent = "Task: " + exportInfo[i][0] + " " + exportInfo[i][1] + " minutes";
                });
                setTimerText("#totalCountdown", globalSecondsRemaining);
                setTimerText("#taskCountdown", taskSecondsRemaining);
            }
            document.getElementById("start").disabled = false;
        }

        /* Hard reset for the entire app (timer and all tasks) */

        function clear() {
            stop();

            globalSeconds = 0;
            globalSecondsRemaining = 0;
            exportInfo = [];
            backupArray = [];

            $("#timerTaskList").empty();

            resetTimerText("#totalTime");
            resetTimerText("#totalCountdown");
            resetTimerText("#taskCountdown");

            if (document.querySelector('input[type="file"]') != null) {
                document.getElementById("importCSV").value = "";
            }
        }

        //TASK FUNCTIONS

        /* Adds task input from text/number forms and adds <li> items accordingly.
         Increments the global time variables every time a new task is added,
         and calls setTimerText() to increment the timer on the UI.
         This function should only be called inside the onclick function for
         the add task button and from within parseCSV() */

        function addTask(task, minutes) {
            //Input check
            if (IsNullOrWhiteSpace(task) || IsNullOrWhiteSpace(minutes) || minutes === '0') {
                //Shows error message if task name or duration is empty.
                document.getElementById('alertText').textContent = "Empty name or duration.";
                $("#alert").addClass('show').fadeTo(2000, 500).slideUp(500);
            } else {
                //Add <h3> Sub Task title if one doesn't already exist.
                if (!document.getElementById("currentTasks")) {
                    $('<h3>').addClass('text-center').attr('id', 'currentTasks').text("Sub Tasks").appendTo("#timerTaskList");
                }

                globalSeconds += minutes * 60;
                globalSecondsRemaining += minutes * 60;

                //Update task time-tracking variables if this is the first task to be entered.
                if (document.getElementsByTagName('li').length === 0) {
                    taskSeconds = minutes * 60;
                    taskSecondsRemaining = taskSeconds;
                }

                //Export to CSV array
                exportInfo.push([task, minutes]);
                backupArray.push([task, minutes]);

                //Append to 'timerTaskList'.
                $('<li>').addClass('list-group-item list-group-item-action')
                    .attr('id', 'listItem')
                    .text("Task: " + task + " " + minutes + " minutes").attr('draggable', 'true')
                    .attr('minutes', minutes).attr('complete', 'false').attr('active', 'false')
                    .appendTo("#timerTaskList");

                $("#addTask").val("");
                $("#addTaskDuration").val(0);

                //Fixes a bug that occurs in the task timer when all tasks are finished, then new one(s) added, and start is pressed.
                if (taskSeconds === 0 && globalSecondsRemaining != 0) {

                    const taskList = document.getElementsByTagName('li');
                    let i = 0;

                    while (true) {
                        if (typeof (taskList[i]) === "undefined") {
                            break;
                        }
                        if (taskList[i].getAttribute('complete') === 'false') {
                            taskSeconds = taskList[i].getAttribute('minutes') * 60;
                            taskSecondsRemaining = taskSeconds;
                            //Fixes a visual bug that occurs in the same context, and prevents the timer from displaying this task.
                            setTimerText("#taskCountdown", taskSecondsRemaining);
                            break;
                        }
                        i++;
                    }
                }
                setTimerText("#totalTime", globalSeconds);
                setTimerText("#totalCountdown", globalSecondsRemaining);

                //Instantiate the task countdown timer if this is the first task.
                if (document.getElementsByTagName('li').length === 1) {
                    setTimerText("#taskCountdown", taskSecondsRemaining);
                }
            }
        }

        /* Takes the id of the timer as an input, as well as the seconds remaining for that particular timer */

        function setTimerText(id, secondsRemaining) {

            const hms = toHMS(secondsRemaining);
            let [hours, minutes, seconds] = hms;

            if (hours < 10) {
                hours = "0" + hours;
            }
            if (minutes < 10) {
                minutes = "0" + minutes;
            }
            if (seconds < 10) {
                seconds = "0" + seconds;
            }
            $(id).text(hours + ":" + minutes + ":" + seconds);
        }

        //CSV FUNCTIONS

        /* Imports the CSV file provided by the user, which is then passed onto parseCSV() */

        function importCSV() {
            const reader = new FileReader();
            const input = document.querySelector('input[type="file"]');
            reader.readAsText(input.files[0]);
            reader.onload = function () {
                parseCSV(reader.result);
            }

            // Show importCSV success notification
            document.getElementById('alertText').textContent = "Imported CSV file.";
            $("#alert").addClass('show').fadeTo(2000, 500).slideUp(500);
        }

        /* Parses the imported CSV file passed on by importCSV(), calls addTask(task, minutes) for each task
         specified in the CSV file */

        function parseCSV(data) {
            // Add <h3> Sub Task title if one doesn't already exist.
            if (!document.getElementById("currentTasks")) {
                $('<h3>').addClass('text-center').attr('id', 'currentTasks').text("Sub Tasks").appendTo("#timerTaskList");
            }

            //Split the string, store in array, pop the last element (empty string), and splice the first two elements (headers).
            const dataArray = data.replace(/\n/g, ",").split(",");
            dataArray.pop();
            dataArray.splice(0, 2);

            //Store the data in arrays and add to task list.
            $.each(dataArray, function (i) {
                if (i % 2 === 0) {
                    addTask(dataArray[i], dataArray[i + 1]);
                }
            });
        }

        /* exportCSV() gathers the current CSV cache and downloads a CSV file with the appropriate data. */

        function exportCSV() {
            // if csv info is empty, dont download
            if (exportInfo.length === 0) {
                //show empty CSV cache error.
                document.getElementById('alertText').textContent = "Nothing to export!";
                $("#alert").addClass('show').fadeTo(2000, 500).slideUp(500);
            } else {
                // csv string to build upon, starts with title
                let csv = "placeholder,taskName,minutes\n";
                // for each, join each arr row with a comma and end with a new line
                exportInfo.forEach(function (row) {
                    csv += row.join(',');
                    csv += "\n";
                });

                // create download link for csv file
                const hiddenElement = document.createElement('a');
                hiddenElement.href = 'data:text/csv;charset=utf-8' + encodeURI(csv);
                hiddenElement.target = "_blank";
                hiddenElement.download = 'data.csv';
                hiddenElement.click();

                //Show exportCSV success notification.
                document.getElementById('alertText').textContent = "Downloaded CSV file.";
                $("#alert").addClass('show').fadeTo(2000, 500).slideUp(500);
            }
        }


        //UTILITY FUNCTIONS

        /* Accepts hours, minutes and seconds as an input , returns the time value in seconds) */
        function toSeconds(hours, minutes, seconds) {
            return (hours * 3600) + (minutes * 60) + seconds;
        }

        /* Accepts seconds as input and returns hours, minutes and seconds as an array where
         [0] is hours, [1] is minutes, and [2] is seconds. */
        function toHMS(totalSeconds) {
            const hours = Math.floor((totalSeconds / 3600));
            const minutes = Math.floor((totalSeconds / 60) % 60);
            const seconds = Math.floor(totalSeconds % 60);
            return [hours, minutes, seconds];
        }

        /* Accepts the id (string) of the timer as input, e.g for total time it's '#totalTime',
         for total time remaining it's '#totalCountdown', and for task time, it's '#taskCountdown' */

        function resetTimerText(id) {
            $(id).text("00:00:00");
        }

        function IsNullOrWhiteSpace(value) {
            if (value == null)
                return true;
            return value.replace(/\s/g, '').length === 0;
        }

    </script>
</body>

</html>