<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="Content/bootstrap.css" rel="stylesheet" />
    <link href="Content/Site.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Raleway" />

    <script src="Scripts/jquery-3.5.1.js"></script>
    <script src="Scripts/popper.js"></script>
    <script src="Scripts/bootstrap.js"></script>

    <title>TeamTime</title>
</head>

<body>
    <nav class="navbar">
        <span class="navbar-brand"><strong>TeamTime</strong></span>
    </nav>
    <div class="container-fluid" id="main">
        <div class="row">
            <!-- timer div -->
            <div class="col-7" id="timer">
                <div>
                    <h2 class="text-center">Timer</h2>
                </div>
                <div class="body-content">
                    <!-- total timer: the total of all sub-tasks -->
                    <div class="row" id="totalTime" style="justify-content: center">
                        <h6>Total Time</h6>
                        <h4 class="form-text text-muted">H</h4>
                        <h3 id="totalTimeHrs">00</h3>
                        <h4 class="form-text text-muted">M</h4>
                        <h3 id="totalTimeMins">00</h3>
                        <h4 class="form-text text-muted">S</h4>
                        <h3 id="totalTimeSecs">00</h3>
                    </div>
                    <!-- Total time countdown-->
                    <div class="row" id="globalCountdown" style="justify-content: center">
                        <h6>Total Remaining</h6>
                        <h4 class="form-text text-muted">H</h4>
                        <h3 id="globalCountdownHrs">00</h3>
                        <h4 class="form-text text-muted">M</h4>
                        <h3 id="globalCountdownMins">00</h3>
                        <h4 class="form-text text-muted">S</h4>
                        <h3 id="globalCountdownSecs">00</h3>
                    </div>
                    <!-- Task Time countdown-->
                    <div class="row" id="taskCountdown" style="justify-content: center">
                        <h6>Task Time</h6>
                        <h4 class="form-text text-muted">H</h4>
                        <h3 id="taskCountdownHrs">00</h3>
                        <h4 class="form-text text-muted">M</h4>
                        <h3 id="taskCountdownMins">00</h3>
                        <h4 class="form-text text-muted">S</h4>
                        <h3 id="taskCountdownSecs">00</h3>
                    </div>
                    <!-- Timer Buttons -->
                    <div class="row" style="justify-content: center" id="timerButtons">
                        <button type="button" id="start">Start</button>
                        <button type="button" id="pause">Pause</button>
                        <button type="button" id="stop">Stop</button>
                        <button type="button" id="clear">Clear</button>
                    </div>
                </div>
                <!-- Task List -->
                <div class="row">
                    <ol id="timerTaskList" style="width: 100%">
                    </ol>
                </div>
            </div>
            <!-- Configure div -->
            <div class="col-3" id="settings">
                <div>
                    <h2 class="text-center">Configure</h2>
                </div>
                <div class="body-content">
                    <div class="form-group">
                        <div>
                            <small class="form-text text-muted"><strong>Enter a task name</strong></small>
                            <input type="text" class="form-control" id="addTask" />
                        </div>
                        <div>
                            <small class="form-text text-muted"><strong>Enter a task duration (minutes)</strong></small>
                            <input type="number" class="form-control" id="addTaskDuration" />
                        </div>
                        <div style="text-align: center">
                            <button id="task" style="margin-top: 15px">Add Task</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>

        //back

        //Global Variables
        var myTimer;

        var globalSeconds = 0;
        var globalSecondsCompleted = 0;
        var globalSecondsRemaining = 0;

        var taskSeconds = 0;
        var taskSecondsCompleted = 0;
        var taskSecondsRemaining = 0;

        var taskTracker = 0;

        var exportInfo = [];
        var backupArray = [];

        var paused = false;
        var started = false;

        //Event Handlers
        $("#task").on('click', function () { addTask($("#addTask").val(), $("#addTaskDuration").val()); });
        $("#start").on('click', start);
        $("#pause").on('click', pause);
        $("#stop").on('click', stop);
        $("#clear").on('click', clear);

        //TIMER FUNCTIONS

        function start() {
            //Prevent start from executed if there are no tasks or all tasks are already complete.
            if (globalSecondsRemaining === 0)
                return;

            document.getElementById("start").innerHTML = "Start";
            this.disabled = true;
            started = true;
            paused = false;

            myTimer = setInterval(timer, 10);
        }

        /* Contains the core logic for the timer, and tracks the status of sub-tasks */

        function timer() {
            const currentTask = document.getElementsByTagName('li')[taskTracker];
            const nextTask = document.getElementsByTagName('li')[taskTracker + 1];

            if (typeof (currentTask) != "undefined") {
                currentTask.setAttribute('active', 'true');
            }

            globalSecondsCompleted++;
            globalSecondsRemaining--;
            taskSecondsCompleted++;
            taskSecondsRemaining--;

            //Completed task
            if (currentTask.getAttribute('minutes') * 60 === taskSecondsCompleted) {
                currentTask.setAttribute('complete', 'true');
                currentTask.setAttribute('active', 'false');
                currentTask.textContent += ": Complete";
                taskSecondsCompleted = 0;
                taskTracker++;

                //Sets the task timer to the next task (if there is one)
                if (typeof (nextTask) != "undefined") {
                    taskSeconds = nextTask.getAttribute('minutes') * 60;
                    taskSecondsRemaining = taskSeconds;
                }
            }

            updateTimerText("#globalCountdown", globalSecondsRemaining);
            updateTimerText("#taskCountdown", taskSecondsRemaining);

            //All tasks completed
            if (globalSecondsRemaining <= 0) {
                clearInterval(myTimer);
                document.getElementById("start").disabled = false;
                started = false;
                taskSeconds = 0;
                taskSecondsRemaining = 0;
            }
        }

        /* Pauses the timer */

        function pause() {
            if (paused || !started)
                return;

            clearInterval(myTimer);
            paused = true;
            document.getElementById("start").innerHTML = "Resume";
            document.getElementById("start").disabled = false;
        }

        /* Resets the timer to default values without deleting any tasks */

        function stop() {

            clearInterval(myTimer);

            paused = false;
            started = false;
            globalSecondsCompleted = 0;
            globalSecondsRemaining = globalSeconds;
            taskSeconds = 0;
            taskSecondsCompleted = 0;
            taskSecondsRemaining = 0;
            taskTracker = 0;

            document.getElementById("start").innerHTML = "Start";

            //This block of code doesn't execute when this method is called inside clear().
            //Resets all tasks to display as incomplete and resets the task timer.
            if (this === document.getElementById("stop")) {
                const taskList = document.getElementsByTagName('li');
                $.each(taskList, function (i) {

                    if (i === 0 && typeof (taskList[0]) != "undefined") {
                        taskSeconds = taskList[0].getAttribute('minutes') * 60;
                        taskSecondsRemaining = taskSeconds;
                    }
                    if (taskList[i].getAttribute('complete') === 'true') {
                        taskList[i].setAttribute('complete', 'false');
                    }
                    if (taskList[i].getAttribute('active') === 'true') {
                        taskList[i].setAttribute('active', 'false');
                    }
                    taskList[i].textContent = "Task: " + exportInfo[i][0] + " " + exportInfo[i][1] + " minutes";
                });
                updateTimerText("#globalCountdown", globalSecondsRemaining);
                updateTimerText("#taskCountdown", taskSecondsRemaining);
            }
            document.getElementById("start").disabled = false;
        }

        /* Hard reset for the entire app (timer and all tasks) */

        function clear() {
            stop();

            globalSeconds = 0;
            globalSecondsRemaining = 0;
            exportInfo = [];
            backupArray = [];

            $("#timerTaskList").empty();

            resetTimerText("#totalTime");
            resetTimerText("#globalCountdown");
            resetTimerText("#taskCountdown");
        }

        //TASK FUNCTIONS

        /* Adds task input from text/number forms and adds <li> items accordingly.
         Increments the global time variables every time a new task is added,
         and calls setTimerText() to increment the timer on the UI.
         This function should only be called inside the onclick function for
         the add task button and from within parseCSV() */

        function addTask(task, minutes) {
            // input check
            if (IsNullOrWhiteSpace(task) || IsNullOrWhiteSpace(minutes) || minutes === '0') {
                window.alert("You cannot have an empty task name or duration.");
            } else {
                //Add <h3> Sub Task title if one doesn't already exist.
                if (!document.getElementById("currentTasks")) {
                    $('<h3>').addClass('text-center').attr('id', 'currentTasks').text("Sub Tasks").appendTo("#timerTaskList");
                }

                globalSeconds += minutes * 60;
                globalSecondsRemaining += minutes * 60;

                //Update task time-tracking variables if this is the first task to be entered.
                if (document.getElementsByTagName('li').length === 0) {
                    taskSeconds = minutes * 60;
                    taskSecondsRemaining = taskSeconds;
                }

                //Export to CSV array
                exportInfo.push([task, minutes]);
                backupArray.push([task, minutes]);

                //Append to 'timerTaskList'.
                $('<li>').addClass('list-group-item list-group-item-action')
                    .attr('id', 'listItem')
                    .text("Task: " + task + " " + minutes + " minutes").attr('draggable', 'true')
                    .attr('minutes', minutes).attr('complete', 'false').attr('active', 'false')
                    .appendTo("#timerTaskList");

                $("#addTask").val("");
                $("#addTaskDuration").val(0);

                //Fixes a bug that occurs in the task timer when all tasks are finished, then new one(s) added, and start is pressed.
                if (taskSeconds === 0 && globalSecondsRemaining != 0) {

                    const taskList = document.getElementsByTagName('li');
                    let i = 0;

                    while (true) {
                        if (typeof(taskList[i]) === "undefined") {
                            break;
                        }
                        if (taskList[i].getAttribute('complete') === 'false') {
                            taskSeconds = taskList[i].getAttribute('minutes') * 60;
                            taskSecondsRemaining = taskSeconds;
                            //Fixes a visual bug that occurs in the same context, and prevents the timer from displaying this task.
                            setTimerText("#taskCountdown", taskSecondsRemaining);
                            break;
                        }
                        i++;
                    }
                }
                setTimerText("#totalTime", globalSeconds);
                setTimerText("#globalCountdown", globalSecondsRemaining);

                //Instantiate the task countdown timer if this is the first task.
                if (document.getElementsByTagName('li').length === 1) {
                    setTimerText("#taskCountdown", taskSecondsRemaining);
                }
            }
        }

        /* Takes the id of the timer as an input, as well as the seconds remaining for that particular timer,
         and sets/updates the time displayed to the user.
         There should be no reason to call this function outside of addTask() */

        function setTimerText(id, secondsRemaining) {

            const hms = toHMS(secondsRemaining);
            let [hours, minutes, seconds] = hms;

            if (hours < 10) {
                hours = "0" + hours;
            }
            if (minutes < 10) {
                minutes = "0" + minutes;
            }
            if (seconds < 10) {
                seconds = "0" + seconds;
            }

            $(id + "Hrs").text(hours);
            $(id + "Mins").text(minutes);
            $(id + "Secs").text(seconds);
        }


        //UTILITY FUNCTIONS

        /* Accepts hours, minutes and seconds as an input , returns the time value in seconds) */
        function toSeconds(hours, minutes, seconds) {
            return (hours * 3600) + (minutes * 60) + seconds;
        }

        /* Accepts seconds as input and returns hours, minutes and seconds as an array where
         [0] is hours, [1] is minutes, and [2] is seconds. */
        function toHMS(totalSeconds) {
            const hours = Math.floor((totalSeconds / 3600));
            const minutes = Math.floor((totalSeconds / 60) % 60);
            const seconds = Math.floor(totalSeconds % 60);
            return [hours, minutes, seconds];
        }

        /* Accepts the partial id (string) of the timer as input, e.g for total time it's '#totalTime',
         for total time remaining it's '#globalCountdown', and for task time, it's '#taskCountdown'
         There is no need to enter in the full id (Hrs, Mins or Secs) in the string, just the general id
         of the timer. It resets the chosen timer to default values. */

        function resetTimerText(id) {
            $(id + "Hrs").text("00");
            $(id + "Mins").text("00");
            $(id + "Secs").text("00");
        }

        /* Same deal as resetTimerText(), this also requires secondsRemaining for whichever timer's id
         is being passed into function, it simply updates the timer on UI with the correct formatting */

        function updateTimerText(id, secondsRemaining) {
            const hms = toHMS(secondsRemaining);
            const [hoursRemaining, minsRemaining, secsRemaining] = hms;

            if (hoursRemaining < 10) {
                $(id + "Hrs").text("0" + hoursRemaining);
            } else {
                $(id + "Hrs").text(hoursRemaining);
            }
            if (minsRemaining < 10) {
                $(id + "Mins").text("0" + minsRemaining);
            } else {
                $(id + "Mins").text(minsRemaining);
            }
            if (secsRemaining < 10) {
                $(id + "Secs").text("0" + secsRemaining);
            } else {
                $(id + "Secs").text(secsRemaining);
            }
        }

        function IsNullOrWhiteSpace(value) {
            if (value == null)
                return true;
            return value.replace(/\s/g, '').length === 0;
        }

    </script>
</body>

</html>